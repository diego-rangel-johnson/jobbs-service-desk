<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .resultado { margin: 10px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        .sucesso { border-color: #4CAF50; background: #e8f5e9; }
        .erro { border-color: #f44336; background: #ffebee; }
        button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; cursor: pointer; }
        button:hover { background: #1976D2; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Teste de Conectividade Supabase</h1>
    
    <div>
        <button onclick="testarConexao()">ğŸ”Œ Testar ConexÃ£o</button>
        <button onclick="carregarTickets()">ğŸ« Carregar Tickets</button>
        <button onclick="testarAuth()">ğŸ” Testar Auth</button>
        <button onclick="criarTicketTeste()">â• Criar Ticket Teste</button>
        <button onclick="testarStorage()">ğŸ“ Testar Storage</button>
        <button onclick="listarAnexos()">ğŸ“ Listar Anexos</button>
        <button onclick="testarCriacaoTicketSimples()">ğŸ« Criar Ticket Simples</button>
    </div>

    <div>
        <h3>Teste de Upload de Anexo</h3>
        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt">
        <button onclick="testarUploadAnexo()">ğŸ“¤ Upload Teste</button>
    </div>

    <div id="resultados"></div>

    <script>
        // Configurar Supabase com as credenciais corretas
        const SUPABASE_URL = "https://tjjpwsjrmoisowewebcs.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqanB3c2pybW9pc293ZXdlYmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0OTA5MTMsImV4cCI6MjA2NzA2NjkxM30.hcBhJ96I5WGmacQswHkb5O-3wymLo50QQ1zPLnTbsI8";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function adicionarResultado(texto, sucesso = true) {
            const div = document.createElement('div');
            div.className = `resultado ${sucesso ? 'sucesso' : 'erro'}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${texto}`;
            document.getElementById('resultados').insertBefore(div, document.getElementById('resultados').firstChild);
        }

        async function testarConexao() {
            adicionarResultado('ğŸ”„ Testando conexÃ£o com Supabase...');
            try {
                const { data, error } = await supabase
                    .from('tickets')
                    .select('count', { count: 'exact' })
                    .limit(1);

                if (error) {
                    adicionarResultado(`âŒ Erro na conexÃ£o: ${error.message}`, false);
                } else {
                    adicionarResultado(`âœ… ConexÃ£o OK! Tickets no banco: ${data?.length || 'N/A'}`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function carregarTickets() {
            adicionarResultado('ğŸ”„ Carregando tickets...');
            try {
                const { data: tickets, error } = await supabase
                    .from('tickets')
                    .select(`
                        id,
                        ticket_number,
                        subject,
                        status,
                        priority,
                        department,
                        created_at
                    `)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    adicionarResultado(`âŒ Erro ao carregar tickets: ${error.message}`, false);
                } else {
                    const ticketsTexto = tickets.map(t => 
                        `${t.ticket_number}: ${t.subject} (${t.status})`
                    ).join('<br>');
                    adicionarResultado(`âœ… ${tickets.length} tickets carregados:<br>${ticketsTexto}`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function testarAuth() {
            adicionarResultado('ğŸ”„ Testando estado de autenticaÃ§Ã£o...');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    adicionarResultado(`âŒ Erro de autenticaÃ§Ã£o: ${error.message}`, false);
                } else if (session) {
                    adicionarResultado(`âœ… UsuÃ¡rio logado: ${session.user.email}`);
                } else {
                    adicionarResultado(`â„¹ï¸ Nenhum usuÃ¡rio logado`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function criarTicketTeste() {
            adicionarResultado('ğŸ”„ Tentando criar ticket de teste...');
            try {
                // Primeiro obter usuÃ¡rio logado
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    adicionarResultado('âŒ UsuÃ¡rio nÃ£o estÃ¡ logado. FaÃ§a login primeiro.', false);
                    return;
                }

                const { data, error } = await supabase
                    .from('tickets')
                    .insert([{
                        subject: 'ğŸ§ª Teste HTML - ' + new Date().toLocaleTimeString(),
                        description: 'Ticket criado via teste HTML para verificar conectividade',
                        priority: 'medium',
                        department: 'TI',
                        customer_id: user.id,
                        status: 'open'
                    }])
                    .select();

                if (error) {
                    adicionarResultado(`âŒ Erro ao criar ticket: ${error.message}`, false);
                } else {
                    adicionarResultado(`âœ… Ticket criado: ${data[0]?.ticket_number || 'ID nÃ£o disponÃ­vel'}`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function testarStorage() {
            adicionarResultado('ğŸ”„ Testando sistema de storage...');
            try {
                // Testar se o bucket ticket-attachments existe
                const { data, error } = await supabase.storage
                    .from('ticket-attachments')
                    .list('', { limit: 1 });

                if (error) {
                    adicionarResultado(`âŒ Bucket ticket-attachments nÃ£o encontrado: ${error.message}`, false);
                    
                    // Tentar criar o bucket
                    adicionarResultado('ğŸ”„ Tentando criar bucket ticket-attachments...');
                    const { data: bucketData, error: bucketError } = await supabase.storage
                        .createBucket('ticket-attachments', { public: false });
                    
                    if (bucketError) {
                        adicionarResultado(`âŒ Erro ao criar bucket: ${bucketError.message}`, false);
                    } else {
                        adicionarResultado(`âœ… Bucket criado com sucesso!`);
                    }
                } else {
                    adicionarResultado(`âœ… Bucket ticket-attachments existe e estÃ¡ configurado!`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function listarAnexos() {
            adicionarResultado('ğŸ”„ Listando anexos no banco de dados...');
            try {
                const { data: anexos, error } = await supabase
                    .from('ticket_attachments')
                    .select(`
                        id,
                        file_name,
                        file_size,
                        file_type,
                        created_at,
                        ticket_id
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    adicionarResultado(`âŒ Erro ao listar anexos: ${error.message}`, false);
                } else {
                    if (anexos.length === 0) {
                        adicionarResultado(`â„¹ï¸ Nenhum anexo encontrado no banco de dados`);
                    } else {
                        const anexosTexto = anexos.map(a => 
                            `${a.file_name} (${Math.round(a.file_size / 1024)}KB) - Ticket ID: ${a.ticket_id}`
                        ).join('<br>');
                        adicionarResultado(`âœ… ${anexos.length} anexos encontrados:<br>${anexosTexto}`);
                    }
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function testarUploadAnexo() {
            adicionarResultado('ğŸ”„ Tentando fazer upload de anexo de teste...');
            try {
                const file = document.getElementById('fileInput').files[0];
                if (!file) {
                    adicionarResultado('âŒ Nenhum arquivo selecionado', false);
                    return;
                }

                // Verificar se o usuÃ¡rio estÃ¡ logado
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    adicionarResultado('âŒ UsuÃ¡rio nÃ£o estÃ¡ logado. FaÃ§a login primeiro.', false);
                    return;
                }

                // Gerar nome Ãºnico para o arquivo
                const timestamp = new Date().getTime();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `teste/${user.id}/${timestamp}_${sanitizedFileName}`;

                // Upload para o Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('ticket-attachments')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    adicionarResultado(`âŒ Erro ao fazer upload: ${uploadError.message}`, false);
                } else {
                    adicionarResultado(`âœ… Upload realizado com sucesso! Arquivo: ${fileName}`);
                    
                    // Tentar criar registro na tabela de anexos (simulando)
                    adicionarResultado('ğŸ”„ Criando registro de anexo no banco...');
                    const { data: attachmentData, error: attachmentError } = await supabase
                        .from('ticket_attachments')
                        .insert({
                            ticket_id: '00000000-0000-0000-0000-000000000000', // ID fictÃ­cio para teste
                            file_name: file.name,
                            file_url: fileName,
                            file_size: file.size,
                            file_type: file.type,
                            uploaded_by: user.id
                        })
                        .select()
                        .single();

                    if (attachmentError) {
                        adicionarResultado(`âš ï¸ Upload OK, mas erro ao salvar no banco: ${attachmentError.message}`, false);
                    } else {
                        adicionarResultado(`âœ… Anexo registrado no banco com ID: ${attachmentData.id}`);
                    }
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
            }
        }

        async function testarCriacaoTicketSimples() {
            adicionarResultado('ğŸ”„ Testando criaÃ§Ã£o simples de ticket...');
            try {
                // Primeiro obter usuÃ¡rio logado
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    adicionarResultado('âŒ UsuÃ¡rio nÃ£o estÃ¡ logado. FaÃ§a login primeiro.', false);
                    return;
                }

                // Criar ticket com dados mÃ­nimos
                const { data, error } = await supabase
                    .from('tickets')
                    .insert({
                        subject: 'ğŸ§ª Teste Simples - ' + new Date().toLocaleTimeString(),
                        description: 'Ticket de teste criado para verificar funcionamento bÃ¡sico',
                        priority: 'medium',
                        department: 'TI',
                        customer_id: user.id,
                        status: 'open'
                    })
                    .select('*')
                    .single();

                if (error) {
                    adicionarResultado(`âŒ Erro ao criar ticket simples: ${error.message}`, false);
                    console.error('Erro detalhado:', error);
                } else {
                    adicionarResultado(`âœ… Ticket simples criado com sucesso!`);
                    adicionarResultado(`ğŸ“‹ ID: ${data.id}`);
                    adicionarResultado(`ğŸ« NÃºmero: ${data.ticket_number || 'NÃ£o gerado'}`);
                    adicionarResultado(`ğŸ“ Assunto: ${data.subject}`);
                }
            } catch (err) {
                adicionarResultado(`ğŸ’¥ Erro inesperado: ${err.message}`, false);
                console.error('Erro completo:', err);
            }
        }

        // Testar conexÃ£o automaticamente ao carregar
        window.onload = function() {
            adicionarResultado('ğŸš€ PÃ¡gina carregada! Clique nos botÃµes para testar.');
            testarConexao();
        };
    </script>
</body>
</html> 